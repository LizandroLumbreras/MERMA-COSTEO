<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Costeo de Merma</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    :root{
      --principal:#e60000; --texto:white;
      --fondo:linear-gradient(to right,#00416A,#E4E5E6);
      --sombra:rgba(0,0,0,.1); --card-bg:rgba(255,255,255,.15)
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:'Poppins',sans-serif;background:var(--fondo);color:var(--texto);min-height:100vh;padding:0 20px 40px}
    .marca-agua{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);opacity:.08;z-index:0;max-width:80%;pointer-events:none}
    header{text-align:center;padding:20px;background:rgba(255,255,255,.1);box-shadow:0 2px 6px var(--sombra);position:relative;z-index:2}
    h2{text-align:center;margin:10px 0;font-size:26px}
   .input-box,table{
  max-width:900px;
  margin:20px auto;
  background:rgba(255,255,255,.15);
  padding:20px;
  border-radius:12px;
  box-shadow:0 2px 6px var(--sombra);
  position:relative; /* üëà IMPORTANTE */
  z-index:50;
}
    input,textarea{width:100%;padding:12px;margin:10px 0;font-size:16px;border:none;border-radius:6px}
    input:focus,textarea:focus{outline:2px solid #fff}
    button{padding:10px 20px;background:var(--principal);color:white;border:none;cursor:pointer;border-radius:8px;font-weight:bold;box-shadow:0 2px 4px var(--sombra);margin-top:10px}
    table{width:100%;border-collapse:collapse;margin-top:20px}
    th,td{border:1px solid rgba(255,255,255,.3);padding:10px;text-align:left}
    th{background:#003366;color:white}
    td{color:white;background:rgba(255,255,255,.05)}
    #totalGeneral{font-size:20px;text-align:right;margin-top:20px;font-weight:bold}
    .descripcion-box{font-weight:bold;color:#fff;background:rgba(0,0,0,.2);padding:10px;border-radius:6px;min-height:44px;display:flex;align-items:center}
    footer{width:100%;text-align:center;font-size:13px;color:#fff;background:#00416A;padding:15px 10px;border-top:1px solid rgba(255,255,255,.1);margin-top:40px}
    footer span{font-weight:600}
  </style>
</head>
<body>
  <img src="logo_proveedora.webp" class="marca-agua" alt="Marca de agua" loading="lazy" />
  <header><h2>üìâ Costeo de Merma</h2></header>

<div class="input-box">
  <input type="text" id="codigoInput" placeholder="Escanea o escribe el c√≥digo de barras" />

<div id="sugerencias" style="
  background:white;
  color:black;
  border-radius:6px;
  max-height:220px;
  overflow-y:auto;
  display:none;
  position:absolute;
  z-index:9999;
  width:calc(100% - 40px);
  left:20px;
  top:60px;
  box-shadow:0 10px 24px rgba(0,0,0,.25);
"></div>

  <div class="descripcion-box" id="descripcionProducto"></div>
  <input type="number" id="cantidadInput" placeholder="Cantidad (piezas o kg)" />
  <textarea id="motivoInput" placeholder="Motivo de la merma"></textarea>
  <input type="text" id="sucursalInput" placeholder="Sucursal o Bodega" />
  <button id="btnAgregar">‚ûï Agregar a la tabla</button>
</div>

  <table id="tablaMerma">
    <thead>
      <tr>
        <th>Descripci√≥n</th>
        <th>Motivo Merma</th>
        <th>Cantidad</th>
        <th>Costo Unitario</th>
        <th>Total</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div id="totalGeneral">Total General: $0.00</div>
  <div style="text-align:center;">
    <button id="btnGuardar">üíæ Guardar mermas</button>
  </div>

  <footer>¬© 2025 <span>Panel de Herramientas La Proveedora</span> ¬∑ Desarrollado por Lizandro Sustaita</footer>

  <script type="module">
    let timeoutBusqueda = null;
    const sugerenciasEl = document.getElementById("sugerencias");
    let mermasCapturadas = [];
    import {
      initializeApp
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
  getFirestore, doc, getDoc,
  collection, addDoc,
  serverTimestamp, query, where, getDocs, limit,
  orderBy, startAfter, documentId
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

import {
  getAuth,
  onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";



    // ‚îÄ‚îÄ Firebase ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const firebaseConfig = {
      apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
      authDomain: "inventariopv-643f1.firebaseapp.com",
      projectId: "inventariopv-643f1",
      storageBucket: "inventariopv-643f1.appspot.com",
      messagingSenderId: "96242533231",
      appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
    };
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);
    const auth = getAuth(app);
const params = new URLSearchParams(window.location.search);
const vieneDeAuditoria = params.get("flow") === "audit";

if (vieneDeAuditoria) {
  onAuthStateChanged(auth, (user) => {
    if (!user) {
      sessionStorage.setItem("redirectAfterLogin", window.location.href);
      window.location.href = "login.html";
    }
  });
}

    // ‚îÄ‚îÄ Cat√°logo en memoria (b√∫squeda local) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let catalogo = [];        // [{id, concepto, concepto_norm, codigoBarra, costoSinImpuesto}]
let catalogoListo = false;

function normalizarTexto(s){
  return (s || "")
    .toString()
    .toLowerCase()
    .normalize("NFD").replace(/[\u0300-\u036f]/g, "") // quita acentos
    .replace(/[^a-z0-9\s\/\-\.\+]/g, " ")            // limpia raro
    .replace(/\s+/g, " ")
    .trim();
}

// Carga una sola vez (por p√°ginas de 1000). Si tienes >1000, sigue trayendo.
async function cargarCatalogoProductos(){
  try{
    catalogo = [];
    catalogoListo = false;

    sugerenciasEl.style.display = "block";
    sugerenciasEl.innerHTML = "<div style='padding:10px'>‚è≥ Cargando cat√°logo...</div>";

    let last = null;

    while(true){
      let q = query(
        collection(db,"productos"),
        orderBy(documentId()),
        limit(1000)
      );

      if(last){
        q = query(
          collection(db,"productos"),
          orderBy(documentId()),
          startAfter(last),
          limit(1000)
        );
      }

      const snap = await getDocs(q);
      if(snap.empty) break;

      snap.forEach(ds=>{
        const d = ds.data();
        const concepto = d.concepto ?? d.descripcion ?? "";
        const codigoBarra = (d.codigoBarra ?? "").toString();
        const costo = Number(d.costoSinImpuesto ?? d.costo ?? 0) || 0;

        catalogo.push({
          id: ds.id,
          concepto,
          concepto_norm: normalizarTexto(concepto),
          codigoBarra: codigoBarra.trim(),
          costoSinImpuesto: costo
        });
      });

      last = snap.docs[snap.docs.length - 1];
      if(snap.size < 1000) break;
    }

    catalogoListo = true;
    sugerenciasEl.style.display = "none";
    sugerenciasEl.innerHTML = "";

    console.log("‚úÖ Cat√°logo cargado:", catalogo.length);

  }catch(e){
    console.error("‚ùå Error cargando cat√°logo:", e);

    catalogoListo = false;
    sugerenciasEl.style.display = "block";
    sugerenciasEl.innerHTML =
      "<div style='padding:10px;color:#b00020;font-weight:600'>" +
      "‚ùå No se pudo cargar el cat√°logo.<br>" +
      "Revisa permisos de Firestore (rules) o login." +
      "</div>";
  }
}

  // ‚îÄ‚îÄ Estado/UI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    let productoActual = null;
    const cuerpoTabla   = document.querySelector("#tablaMerma tbody");
    const totalGeneralEl= document.getElementById("totalGeneral");
    const descEl        = document.getElementById("descripcionProducto");
    const codigoEl      = document.getElementById("codigoInput");

    // ‚úÖ Cargar cat√°logo al iniciar (ESTO TE FALTABA)
cargarCatalogoProductos();

// ‚úÖ Cerrar sugerencias al hacer click fuera (AHORA s√≠ existe codigoEl)
document.addEventListener("click", (e)=>{
  if(!sugerenciasEl.contains(e.target) && e.target !== codigoEl){
    sugerenciasEl.style.display = "none";
  }
});



    // Buscar al presionar Enter o al perder foco
   codigoEl.addEventListener("input", manejarBusqueda);
codigoEl.addEventListener("keydown", e => {
  if(e.key === "Enter"){
    e.preventDefault();
    if(sugerenciasEl.firstChild){
      sugerenciasEl.firstChild.click();
    }else{
      buscarYMostrar(); // fallback c√≥digo de barras
    }
  }
});
    document.getElementById("btnAgregar").addEventListener("click", agregarMerma);
    document.getElementById("btnGuardar").addEventListener("click", guardarMermas);
async function manejarBusqueda(){
  const texto = codigoEl.value.trim();
// Si a√∫n no termina de cargar el cat√°logo, muestra aviso y no sigas
if(!catalogoListo){
  if(texto.length >= 2){
    sugerenciasEl.style.display = "block";
    sugerenciasEl.innerHTML = "<div style='padding:10px'>‚è≥ Cargando cat√°logo...</div>";
  }else{
    sugerenciasEl.style.display = "none";
    sugerenciasEl.innerHTML = "";
  }
  return;
}

// Ya carg√≥: limpia sugerencias antes de buscar
sugerenciasEl.innerHTML = "";
sugerenciasEl.style.display = "none";

  if(texto.length < 2) return;

  clearTimeout(timeoutBusqueda);
  timeoutBusqueda = setTimeout(async ()=>{
    // primero intenta como c√≥digo
    const pareceCodigo = /^\d{3,}$/.test(texto); // solo n√∫meros 3+ (ajusta si quieres)
const porCodigo = pareceCodigo ? await buscarProductoPorCodigo(texto) : null;
    if(porCodigo){
      productoActual = porCodigo;
      descEl.textContent = `${porCodigo.descripcion} | Costo: $${porCodigo.costo.toFixed(2)}`;
      return;
    }

    // si no es c√≥digo, buscar por descripci√≥n
    buscarPorTexto(texto);
  }, 300);
}
function buscarPorTexto(texto){
  if(!catalogoListo){
    sugerenciasEl.style.display = "none";
    return;
  }

  const t = normalizarTexto(texto);
  if(t.length < 2){
    sugerenciasEl.style.display = "none";
    return;
  }

  // ‚Äúcontiene‚Äù en cualquier parte del concepto
  const resultados = catalogo
    .filter(p => p.concepto_norm.includes(t))
    .slice(0, 10);

  if(resultados.length === 0){
    sugerenciasEl.style.display = "none";
    return;
  }

  sugerenciasEl.innerHTML = "";
  sugerenciasEl.style.display = "block";

  resultados.forEach(p=>{
    const prod = {
      descripcion: p.concepto,
      costo: p.costoSinImpuesto,
      id: p.id
    };

    const item = document.createElement("div");
    item.textContent = prod.descripcion;
    item.style.padding = "10px";
    item.style.cursor = "pointer";
    item.style.borderBottom = "1px solid #ddd";

    item.onclick = () => {
      productoActual = prod;
      codigoEl.value = prod.descripcion;
      descEl.textContent = `${prod.descripcion} | Costo: $${prod.costo.toFixed(2)}`;
      sugerenciasEl.style.display = "none";
    };

    sugerenciasEl.appendChild(item);
  });
}

    // ‚îÄ‚îÄ Buscador corregido ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function buscarYMostrar(){
      const codigo = codigoEl.value.trim();
      if(!codigo){ return; }

      const prod = await buscarProductoPorCodigo(codigo);

      if(prod){
        productoActual = prod;
        descEl.textContent = `${prod.descripcion} | Costo: $${prod.costo.toFixed(2)}`;
      }else{
        productoActual = null;
        descEl.textContent = "‚ùå Producto no encontrado";
      }
    }

    /**
     * Busca el producto:
     * 1) por ID del documento (por si algunos est√°n creados as√≠)
     * 2) por campo codigoBarra (y variantes comunes)
     * Retorna { descripcion, costo } o null
     */
    async function buscarProductoPorCodigo(codigo){
      // 0) Intento local (si el cat√°logo ya est√° cargado)
if(catalogoListo){
  const cod = (codigo || "").toString().trim();
const hit = catalogo.find(p => (p.codigoBarra || "").toString().trim() === cod);
  if(hit){
    return { descripcion: hit.concepto, costo: hit.costoSinImpuesto, id: hit.id };
  }
}
      // 1) Intento directo por ID
      try{
        const byId = await getDoc(doc(db, "productos", codigo));
        if(byId.exists()){
          const d = byId.data();
          return mapProducto(d);
        }
      }catch(_){} // si falla, seguimos

      // 2) Intento por campo (variantes t√≠picas)
      const variantes = ["codigoBarra","CodigoBarra","Codigo Barra","Codigo de barras","codigo_barras"];
      for(const campo of variantes){
        const q = query(collection(db,"productos"), where(campo,"==", codigo));
        const snap = await getDocs(q);
        if(!snap.empty){
          const d = snap.docs[0].data();
          return mapProducto(d);
        }
      }
      return null;
    }

    // Mapea distintos esquemas de nombres hacia lo que necesitamos
    function mapProducto(d){
      // descripci√≥n
      const descripcion =
        d.concepto ?? d.Concepto ?? d.descripcion ?? d.Descripcion ?? "SIN DESCRIPCI√ìN";

      // costo: preferimos costoSinImpuesto (como en tu captura)
      const costoBruto =
        d.costoSinImpuesto ?? d["Costo sin Impuesto"] ?? d.costo ?? d.costoUnitario ?? d.costo_unitario ?? 0;

      const costo = Number.parseFloat(costoBruto) || 0;
      return { descripcion, costo };
    }

    // ‚îÄ‚îÄ Tabla/Guardar ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function agregarMerma(){
      if(!productoActual){ return alert("Busca un producto v√°lido primero."); }

      const cantidad = parseFloat(document.getElementById("cantidadInput").value);
      const motivo   = document.getElementById("motivoInput").value.trim();

      if(isNaN(cantidad) || cantidad<=0) return alert("Cantidad inv√°lida.");
      if(!motivo) return alert("Escribe un motivo para la merma.");

      const total = cantidad * productoActual.costo;

// ‚¨áÔ∏è Guardar merma para auditor√≠a
mermasCapturadas.push({
  descripcion: productoActual.descripcion,
  motivo,
  cantidad,
  costo_unitario: productoActual.costo,
  total
});

      const fila = document.createElement("tr");
      fila.innerHTML = `
        <td>${productoActual.descripcion}</td>
        <td>${motivo}</td>
        <td>${cantidad}</td>
        <td>$${productoActual.costo.toFixed(2)}</td>
        <td>$${total.toFixed(2)}</td>
      `;
      cuerpoTabla.appendChild(fila);

      actualizarTotalGeneral();
      limpiarCampos();
    }

    function actualizarTotalGeneral(){
      let total=0;
      cuerpoTabla.querySelectorAll("tr").forEach(row=>{
        const v = parseFloat(row.cells[4].textContent.replace('$',''));
        total += (isNaN(v)?0:v);
      });
      totalGeneralEl.textContent = `Total General: $${total.toFixed(2)}`;
    }

function limpiarCampos(){
  codigoEl.value = "";
  document.getElementById("cantidadInput").value = "";
  document.getElementById("motivoInput").value   = "";
  descEl.textContent = "";
  productoActual = null;

  sugerenciasEl.style.display = "none";
  sugerenciasEl.innerHTML = "";

  codigoEl.focus();
}


async function guardarMermas(){
  if(mermasCapturadas.length === 0){
    return alert("No hay mermas para guardar.");
  }

  const sucursal = document.getElementById("sucursalInput").value.trim();
  if(!sucursal) return alert("Escribe la sucursal o bodega.");

  if(!confirm("¬øDeseas guardar todas las mermas?")) return;

  const ahora = new Date();
  const folio = `MERMA-${ahora.getFullYear()}${String(ahora.getMonth()+1).padStart(2,'0')}${String(ahora.getDate()).padStart(2,'0')}-${String(ahora.getHours()).padStart(2,'0')}${String(ahora.getMinutes()).padStart(2,'0')}${String(ahora.getSeconds()).padStart(2,'0')}`;

  try{
    // üîπ Guardar en Firebase
await Promise.all(
  mermasCapturadas.map(m =>
    addDoc(collection(db,"almacenes","MERMA","registros"),{
      ...m,
      sucursal,
      folio,
      fecha: serverTimestamp()
    })
  )
);


    // üîπ Guardar en auditor√≠a
    localStorage.setItem("aud_mermas", JSON.stringify(mermasCapturadas));

    alert(`‚úÖ Mermas guardadas con folio: ${folio}`);

  if (vieneDeAuditoria) {
  // Sigue flujo de auditor√≠a
  window.location.href = "https://lizandrolumbreras.github.io/Auditorias-sucursales1.0/incidencias.html";
} else {
  // Uso independiente ‚Üí regresar al inicio de merma
  window.location.href = "https://lizandrolumbreras.github.io/MERMA-COSTEO/";
}


  }catch(e){
    console.error(e);
    alert("‚ùå Error al guardar las mermas.");
  }
}
  </script>
</body>
</html>
